ELEMENT.locale(ELEMENT.lang.en);

const SceneEditor = {
    template: '<el-main class="el-workspace-background workspace" id="workspace"><canvas id="canvas" ></canvas></el-main>',
    mounted: function () {
        this.$nextTick(function () {
            window.addEventListener('resize', this.getWindowWidth);
            window.addEventListener('resize', this.getWindowHeight);
            this.getWindowWidth()
            this.getWindowHeight()
        })
    },
    methods: {
        getWindowWidth(event) {
            document.getElementById("canvas").style.width = (document.getElementById("workspace").offsetWidth) + 'px';
        },
        getWindowHeight(event) {
            document.getElementById("canvas").style.height = (document.getElementById("workspace").offsetHeight) + 'px';
        },
    },
    beforeDestroy() {
        window.removeEventListener('resize', this.getWindowWidth);
        window.removeEventListener('resize', this.getWindowHeight);
    }
}
var sketch = VueColor.Sketch;

const SceneLoad = {
    delimiters: ['${', '}'],

    template: '<el-container><el-main>\
    <el-dialog :visible.sync="centerDialogVisible" width="90%" fullscreen :close-on-press-escape="false" :show-close="false" :close-on-click-modal="false">\
    <el-header slot="title" class="autoheight">\
    <el-button type="text" size="small" class="header-text">MockupApp</el-button>\
    </el-header>\
    <el-container class="autoheight">\
    <el-row>\
    <el-col :xs="12" :sm="8" :md="4" :ld="4" :xl="4" v-for="(scene,index) in scenedlist" :key="scene.s_id"><el-card class="el-boundary-background box-card">\
    <el-button type="text" @click="openscene(scene.s_id)" @mouseover.native.prevent="startsequence(index)" @mouseleave.native.prevent="stopsequence(index)">\
    <img :src="scene.s_uri_poster" class="imageres">\
    <div class="scenename">${scene.s_name}</div><el-tag size="mini" type="info"><i class="fa fa-film" aria-hidden="true"></i> Animated</el-tag><el-tag size="mini" type="info" v-if="scene.s_looped"><i class="fa fa-repeat" aria-hidden="true"></i> Looped</el-tag><div class="sceneinfo">${scene.s_frames / 30} sec / ${scene.s_frames} frames</div></el-button></el-card></el-col>\
    </el-row>\
    </el-container>\
    <el-footer slot="footer">Some ads text</el-footer></el-dialog></el-main></el-container>',
    mounted: function () {

        var _this = this;
        axios.post('/api/sceneslist')
        .then(function (response) {
            _this.scenedlist = response.data;
        })
        .catch(function (error) {
            console.log(error);
        });

    },
    data: function () {
        return {
            centerDialogVisible: true,
            sequenceplay: false,
            scenedlist: [],

        }

    },

    methods: {

        startsequence: function (id) {

            this.sequenceplay = id;

            var images = [];
            for (var i = 0; i < this.scenedlist[id].s_uri_preview.length; i++) {
                images[i] = new Image();
                images[i].src = this.scenedlist[id].s_uri_preview[i];
            }

            var _this = this;
            var _pos = 0;
            if (id !== false && this.sequenceplay !== false)
                var uset = setInterval(function () {

                        if (id !== false) {

                            _this.scenedlist[id].s_uri_poster = images[_pos++].src;
                            if (_pos > images.length - 1)
                                _pos = 0;
                        }

                        if (id !== _this.sequenceplay)
                            clearInterval(uset);
                    }, 333);

        },
        stopsequence: function (id) {
            this.sequenceplay = false;
        },

        openscene: function (id) {
            this.$router.push('/edit/' + id)
        }
    },
    beforeDestroy() {
        this.sequenceplay = false;

    }
}

const router = new VueRouter({
        mode: 'history',
        routes: [{
                path: '/',
                component: SceneLoad
            }, {
                path: '/edit/:id',
                component: SceneEditor
            }
        ]
    })

    /////////////////////////////////////////////////////////////////
    var vm = new Vue({
        el: '#app',
        delimiters: ['${', '}'],
        router,
        components: {

            'colorpicker': sketch

        },
        data: {

            fileList: [{
                    name: 'test.jpeg',
                    url: 'https://fuss10.elemecdn.com/3/63/4e7f3a15429bfda99bce42a18cdd1jpeg.jpeg?imageMogr2/thumbnail/360x360/format/webp/quality/100'
                }
            ],
            backgroundcolor: '#194d33',

            scenestore: {
                s_id: 'iphonex-v1',
                s_name: 'IphoneX some data',
                s_uri: '/scenes/iphonex-v3/',
                s_uri_poster: "/scenes/iphonex-v3/preview/Main Comp_00000.jpg",
                "s_uri_preview": ["/scenes/iphonex-v3/preview/Main Comp_00000.jpg", "/scenes/iphonex-v3/preview/Main Comp_00001.jpg", "/scenes/iphonex-v3/preview/Main Comp_00002.jpg", "/scenes/iphonex-v3/preview/Main Comp_00003.jpg", "/scenes/iphonex-v3/preview/Main Comp_00004.jpg", "/scenes/iphonex-v3/preview/Main Comp_00005.jpg", "/scenes/iphonex-v3/preview/Main Comp_00006.jpg", "/scenes/iphonex-v3/preview/Main Comp_00007.jpg", "/scenes/iphonex-v3/preview/Main Comp_00008.jpg", "/scenes/iphonex-v3/preview/Main Comp_00009.jpg", "/scenes/iphonex-v3/preview/Main Comp_00010.jpg", "/scenes/iphonex-v3/preview/Main Comp_00011.jpg"],
                s_mcount: 2,
                s_looped: false,
                s_frames: 120,
                s_layers: [{
                        l_id: '_1',
                        l_name: 'MockupName1',
                        l_data: [{
                                i_mask_uri: 'Mask_right_00000.png',
                                i_img_uri: 'iPhone_right_00001.png',
                                i_icon_uri: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAMAAADDpiTIAAAAA3NCSVQICAjb4U/gAAAACXBIWXMAACNvAAAjb==',
                                i_upperright: '840.75 662.25',
                                i_upperleft: '840.75 662.25',
                                i_lowerright: '840.75 662.25',
                                i_lowerleft: '840.75 662.25'
                            }, {
                                i_mask_uri: 'Mask_right_00000.png',
                                i_img_uri: 'iPhone_right_00001.png',
                                i_icon_uri: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAMAAADDpiTIAAAAA3NCSVQICAjb4U/gAAAACXBIWXMAACNvAAAjb==',
                                i_upperright: '840.75 662.25',
                                i_upperleft: '840.75 662.25',
                                i_lowerright: '840.75 662.25',
                                i_lowerleft: '840.75 662.25'
                            }
                        ],
                        l_enable: true
                    }, {
                        l_id: '_2',
                        l_name: 'MockupName2',
                        l_data: [{
                                i_mask_uri: 'Mask_right_00000.png',
                                i_img_uri: 'iPhone_right_00000.png',
                                i_icon_uri: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAMAAADDpiTIAAAAA3NCSVQICAjb4U/gAAAACXBIWXMAACNvAAAjb==',
                                i_upperright: '840.75 662.25',
                                i_upperleft: '840.75 662.25',
                                i_lowerright: '840.75 662.25',
                                i_lowerleft: '840.75 662.25'
                            }, {
                                i_mask_uri: 'Mask_right_00001.png',
                                i_img_uri: 'iPhone_right_00001.png',
                                i_icon_uri: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAMAAADDpiTIAAAAA3NCSVQICAjb4U/gAAAACXBIWXMAACNvAAAjb==',
                                i_upperright: '840.75 662.25',
                                i_upperleft: '840.75 662.25',
                                i_lowerright: '840.75 662.25',
                                i_lowerleft: '840.75 662.25'
                            }
                        ],
                        l_enable: true
                    }
                ]
            },

            toolbars: [],
            currentframe: 0,
            scale: 100,
            maxframes: 100,
            playbutton: 'fa fa-play',
            playstate: '',
            idscope: 1,
            'layers': [{
                    id: 1,
                    removable: false,
                    icon: 'fa fa-copy',
                    title: 'Mockup',
                    'hidden': true,
                    controller: 'mockup'
                }, {
                    id: 0,
                    removable: false,
                    icon: 'fa fa-paint-brush',
                    title: 'Background',
                    'hidden': false,
                    controller: 'background'
                }
            ]
        },

        methods: {
            updateValue(e) {
                var bgcolor = 'rgba(' +
                    this.backgroundcolor.rgba.r + ',' +
                    this.backgroundcolor.rgba.g + ',' +
                    this.backgroundcolor.rgba.b + ',' +
                    this.backgroundcolor.rgba.a + ')';

                document.getElementById("canvas").style.backgroundColor = bgcolor;
            },

            handleRemove(file, fileList) {
                console.log(file, fileList);
            },
            handlePreview(file) {
                console.log(file);
            },

            backward() {
                if (vm.currentframe > 0)
                    vm.currentframe = vm.currentframe - 1;
            },
            forward() {
                if (vm.currentframe < vm.maxframes)
                    vm.currentframe = vm.currentframe + 1;
            },
            play() {
                if (vm.playbutton == "fa fa-stop") {
                    clearInterval(vm.playstate);
                    vm.playbutton = "fa fa-play";
                } else {
                    vm.playbutton = "fa fa-stop";
                    vm.playstate = setInterval(function () {
                            vm.currentframe = vm.currentframe + 1;
                            if (vm.currentframe > vm.maxframes) {
                                vm.currentframe = 0;
                                vm.playbutton = "fa fa-play";
                                clearInterval(vm.playstate);
                            }
                        }, 33.3);
                }
            },
            curvedraw() {
                document.getElementById("workspace").style.cursor = "crosshair";
                var set = [];
                vm.idscope++;
                vm.layers.unshift({
                    id: vm.idscop,
                    removable: true,
                    icon: 'fa fa-gg',
                    title: 'Shape curve',
                    hidden: false,
                    controller: 'shape'
                });
                _.transform(vm.toolbars, function (result, key) {
                    result.push(key + 1)
                }, set);
                vm.toolbars = set;
                vm.toolbars.unshift(0);
            },
            circledraw() {
                var set = [];
                document.getElementById("workspace").style.cursor = "crosshair";
                vm.idscope++;
                vm.layers.unshift({
                    id: vm.idscop,
                    removable: true,
                    icon: 'fa fa-gg',
                    title: 'Shape circle',
                    hidden: false,
                    controller: 'shape'
                });
                _.transform(vm.toolbars, function (result, key) {
                    result.push(key + 1)
                }, set);
                vm.toolbars = set;
                vm.toolbars.unshift(0);
            },
            squaredraw() {
                var set = [];
                document.getElementById("workspace").style.cursor = "crosshair";
                vm.idscope++;
                vm.layers.unshift({
                    id: vm.idscop,
                    removable: true,
                    icon: 'fa fa-gg',
                    title: 'Shape square',
                    hidden: false,
                    controller: 'shape'
                });
                _.transform(vm.toolbars, function (result, key) {
                    result.push(key + 1)
                }, set);
                vm.toolbars = set;
                vm.toolbars.unshift(0);
            },
            stardraw() {
                var set = [];
                document.getElementById("workspace").style.cursor = "crosshair";
                vm.idscope++;
                vm.layers.unshift({
                    id: vm.idscop,
                    removable: true,
                    icon: 'fa fa-gg',
                    title: 'Shape star',
                    hidden: false,
                    controller: 'shape'
                });
                _.transform(vm.toolbars, function (result, key) {
                    result.push(key + 1)
                }, set);
                vm.toolbars = set;
                vm.toolbars.unshift(0);
            },
            textdraw() {
                var set = [];
                document.getElementById("workspace").style.cursor = "text";
                vm.idscope++;
                vm.layers.unshift({
                    id: vm.idscop,
                    removable: true,
                    icon: 'fa fa-font',
                    title: 'Text',
                    hidden: false,
                    controller: 'text'
                });
                _.transform(vm.toolbars, function (result, key) {
                    result.push(key + 1)
                }, set);
                vm.toolbars = set;
                vm.toolbars.unshift(0);
            },
            undo() {
                document.getElementById("workspace").style.cursor = "default";
            },
            redo() {
                document.getElementById("workspace").style.cursor = "default";
            },
            select() {
                document.getElementById("workspace").style.cursor = "default";
            },
            removelayer(index) {
                var set = [];
                vm.layers.splice(index, 1);
                _.transform(vm.toolbars, function (result, key) {
                    if (key < index)
                        result.push(key);
                    if (key > index)
                        result.push(key - 1)
                }, set);
                vm.toolbars = set;
            },
            togglevisibility(index) {}
        }
    })
